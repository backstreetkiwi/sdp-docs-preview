<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Usage :: Stackable Documentation</title>
    <link rel="canonical" href="https://docs.stackable.tech/airflow/stable/usage.html">
    <meta name="generator" content="Antora 3.1.0">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
    <link rel="icon" href="../../_/img/favicon.png" type="image/png">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://stackable.tech"><img src="../../_/img/stackable-logo.png"></a>
      <a class="navbar-item documentation-link" href="https://docs.stackable.tech">Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search...">
        </div>
      </div>
      <button class="navbar-burger" data-target="navbar-sub">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <a href="https://www.stackable.tech/contact/" class="button pull-right">Contact Us</a>
    </div>
      <div id="topbar-nav" class="navbar-menu">
      </div>
      </div>
    </nav>
    <nav id="navbar-sub" class="navbar-sub">
      <div class="container">
        <a class="navbar-sub-item" href="../../home/stable/index.html">Home</a>
<a class="navbar-sub-item" href="../../home/stable/getting_started.html">Getting Started</a>
<a class="navbar-sub-item" href="../../home/stable/concepts/index.html">Concepts</a>
<a class="navbar-sub-item" href="../../home/stable/tutorials/end-to-end_data_pipeline_example.html">Tutorials</a>
<a class="navbar-sub-item" href="../../stackablectl/stable/index.html">stackablectl</a>
<div class="navbar-sub-item drop-down">
    Operators
    <div class="drop-down-content">
        <a class="drop-down-item" href="../../home/stable/operators/index.html">Overview</a>
        <a class="drop-down-item" href="../stable/index.html">Apache Airflow</a>
        <a class="drop-down-item" href="../../druid/stable/index.html">Apache Druid</a>
        <a class="drop-down-item" href="../../hbase/stable/index.html">Apache HBase</a>
        <a class="drop-down-item" href="../../hdfs/stable/index.html">Apache Hadoop HDFS</a>
        <a class="drop-down-item" href="../../hive/stable/index.html">Apache Hive</a>
        <a class="drop-down-item" href="../../kafka/stable/index.html">Apache Kafka</a>
        <a class="drop-down-item" href="../../nifi/stable/index.html">Apache NiFi</a>
        <a class="drop-down-item" href="../../spark-k8s/stable/index.html">Apache Spark on K8S</a>
        <a class="drop-down-item" href="../../superset/stable/index.html">Apache Superset</a>
        <a class="drop-down-item" href="../../trino/stable/index.html">Trino</a>
        <a class="drop-down-item" href="../../zookeeper/stable/index.html">Apache ZooKeeper</a>
        <a class="drop-down-item" href="../../opa/stable/index.html">OpenPolicyAgent</a>
        <a class="drop-down-item" href="../../commons-operator/stable/index.html">Commons</a>
        <a class="drop-down-item" href="../../secret-operator/stable/index.html">Secret</a>
        <a class="drop-down-item" href="../../listener-operator/stable/index.html">Listener</a>
    </div>
</div>
<a class="navbar-sub-item" href="../../home/stable/contributor/index.html">Contribute</a>

        <a class="arrow" href="javascript:document.querySelector('.navbar-sub').classList.toggle('open')">
          <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"></path></svg>
        </a>
      </div>
    </nav>
  </header>
<div class="body">
    <div class="container">
<div class="nav-container" data-component="airflow" data-version="0.4">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <div class="title-wrapper">
      <h3 class="title"><a href="index.html">Stackable Operator for Apache Airflow</a></h3>
      <div class="page-versions">
        <button class="version-menu-toggle" title="Show other versions of page">0.4</button>
        <div class="version-menu">
          <a class="version" href="../nightly/usage.html">nightly</a>
          <a class="version" href="../stable/usage.html">0.6</a>
          <a class="version" href="../0.5/usage.html">0.5</a>
          <a class="version is-current" href="usage.html">0.4</a>
          <a class="version" href="../0.3/usage.html">0.3</a>
        </div>
      </div>
    </div>
    <ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="installation.html">Installation</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="usage.html">Usage</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Stackable Operator for Apache Airflow</span>
    <span class="version">0.4</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../commons-operator/stable/index.html">Stackable Commons Operator</a>
      <ul class="versions">
        <li class="version">
          <a href="../../commons-operator/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../commons-operator/stable/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../commons-operator/0.3/index.html">0.3</a>
        </li>
        <li class="version">
          <a href="../../commons-operator/0.2/index.html">0.2</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../home/stable/index.html">Stackable Documentation</a>
      <ul class="versions">
        <li class="version">
          <a href="../../home/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../home/stable/index.html">22.11</a>
        </li>
        <li class="version">
          <a href="../../home/22.09/index.html">22.09</a>
        </li>
        <li class="version">
          <a href="../../home/22.06/index.html">22.06</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../listener-operator/stable/index.html">Stackable Listener Operator</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../listener-operator/stable/index.html">nightly</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../stable/index.html">Stackable Operator for Apache Airflow</a>
      <ul class="versions">
        <li class="version">
          <a href="../nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../stable/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../0.5/index.html">0.5</a>
        </li>
        <li class="version is-current">
          <a href="index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../0.3/index.html">0.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../druid/stable/index.html">Stackable Operator for Apache Druid</a>
      <ul class="versions">
        <li class="version">
          <a href="../../druid/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../druid/stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../druid/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../druid/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../druid/0.2/index.html">0.2</a>
        </li>
        <li class="version">
          <a href="../../druid/0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../hbase/stable/index.html">Stackable Operator for Apache HBase</a>
      <ul class="versions">
        <li class="version">
          <a href="../../hbase/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../hbase/stable/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../hbase/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../hbase/0.3/index.html">0.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../hdfs/stable/index.html">Stackable Operator for Apache HDFS</a>
      <ul class="versions">
        <li class="version">
          <a href="../../hdfs/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../hdfs/stable/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../hdfs/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../hdfs/0.4/index.html">0.4</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../hive/stable/index.html">Stackable Operator for Apache Hive</a>
      <ul class="versions">
        <li class="version">
          <a href="../../hive/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../hive/stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../hive/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../hive/0.6/index.html">0.6</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../kafka/stable/index.html">Stackable Operator for Apache Kafka</a>
      <ul class="versions">
        <li class="version">
          <a href="../../kafka/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../kafka/stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../kafka/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../kafka/0.6/index.html">0.6</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../nifi/stable/index.html">Stackable Operator for Apache NiFi</a>
      <ul class="versions">
        <li class="version">
          <a href="../../nifi/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../nifi/stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../nifi/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../nifi/0.6/index.html">0.6</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../spark-k8s/stable/index.html">Stackable Operator for Apache Spark on Kubernetes</a>
      <ul class="versions">
        <li class="version">
          <a href="../../spark-k8s/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../spark-k8s/stable/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../spark-k8s/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../spark-k8s/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../spark-k8s/0.3/index.html">0.3</a>
        </li>
        <li class="version">
          <a href="../../spark-k8s/0.2/index.html">0.2</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../superset/stable/index.html">Stackable Operator for Apache Superset</a>
      <ul class="versions">
        <li class="version">
          <a href="../../superset/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../superset/stable/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../superset/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../superset/0.5/index.html">0.5</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../zookeeper/stable/index.html">Stackable Operator for Apache ZooKeeper</a>
      <ul class="versions">
        <li class="version">
          <a href="../../zookeeper/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../zookeeper/stable/index.html">0.12</a>
        </li>
        <li class="version">
          <a href="../../zookeeper/0.11/index.html">0.11</a>
        </li>
        <li class="version">
          <a href="../../zookeeper/0.10/index.html">0.10</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../opa/stable/index.html">Stackable Operator for OPA</a>
      <ul class="versions">
        <li class="version">
          <a href="../../opa/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../opa/stable/index.html">0.11</a>
        </li>
        <li class="version">
          <a href="../../opa/0.10/index.html">0.10</a>
        </li>
        <li class="version">
          <a href="../../opa/0.9/index.html">0.9</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../trino/stable/index.html">Stackable Operator for Trino</a>
      <ul class="versions">
        <li class="version">
          <a href="../../trino/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../trino/stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../trino/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../trino/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../trino/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../trino/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../trino/0.3/index.html">0.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../secret-operator/stable/index.html">Stackable Secret Operator</a>
      <ul class="versions">
        <li class="version">
          <a href="../../secret-operator/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../secret-operator/stable/index.html">0.5</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../stackablectl/stable/index.html">stackablectl</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../stackablectl/stable/index.html">nightly</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../home/stable/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Stackable Operator for Apache Airflow</a></li>
    <li><a href="usage.html">Usage</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/stackabletech/airflow-operator/blob/docs/0.4/docs/modules/ROOT/pages/usage.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Usage</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Airflow can run in standalone mode (see <a href="https://airflow.apache.org/docs/apache-airflow/stable/start/local.html" class="bare">https://airflow.apache.org/docs/apache-airflow/stable/start/local.html</a>) but requires 2 external dependencies if we want to run jobs across more than one worker: these
dependencies are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an external database (e.g. postgresql) for user/job data, and</p>
</li>
<li>
<p>a queuing component such as Redis.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_external_dependencies_for_the_airflow_usersjob_data_and_job_queues"><a class="anchor" href="#_external_dependencies_for_the_airflow_usersjob_data_and_job_queues"></a>External dependencies for the Airflow users/job data and job queues</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For testing purposes, first add the bitnami repository to helm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm repo add bitnami https://charts.bitnami.com/bitnami</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can spin up a PostgreSQL database with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install airflow-postgresql bitnami/postgresql --version 11.0.0 \
    --set auth.username=airflow \
    --set auth.password=airflow \
    --set auth.database=airflow</code></pre>
</div>
</div>
<div class="paragraph">
<p>A Redis instance can be setup in a similar way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install redis bitnami/redis \
    --set auth.password=redis</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_secret_with_airflow_credentials"><a class="anchor" href="#_secret_with_airflow_credentials"></a>Secret with Airflow credentials</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A secret with the necessary credentials must be created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: simple-airflow-credentials
type: Opaque
stringData:
  adminUser.username: airflow
  adminUser.firstname: Airflow
  adminUser.lastname: Admin
  adminUser.email: airflow@airflow.com
  adminUser.password: airflow
  connections.secretKey: thisISaSECRET_1234
  connections.sqlalchemyDatabaseUri: postgresql+psycopg2://airflow:airflow@airflow-postgresql.default.svc.cluster.local/airflow
  connections.celeryResultBackend: db+postgresql://airflow:airflow@airflow-postgresql.default.svc.cluster.local/airflow
  connections.celeryBrokerUrl: redis://:redis@redis-master:6379/0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>connections.secretKey</code> will be used for securely signing the session cookies and can be used
for any other security related needs by extensions. It should be a long random string of bytes.</p>
</div>
<div class="paragraph">
<p><code>connections.sqlalchemyDatabaseUri</code> must contain the connection string to the SQL database storing
the Airflow metadata.</p>
</div>
<div class="paragraph">
<p><code>connections.celeryResultBackend</code> must contain the connection string to the SQL database storing
the job metadata (in the example above we are using the same postgresql database for both).</p>
</div>
<div class="paragraph">
<p><code>connections.celeryBrokerUrl</code> must contain the connection string to the Redis instance used for queuing
the jobs submitted to the airflow worker(s).</p>
</div>
<div class="paragraph">
<p>The <code>adminUser</code> fields are used by the <code>init</code> command to create an admin user.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creation_of_an_airflow_cluster"><a class="anchor" href="#_creation_of_an_airflow_cluster"></a>Creation of an Airflow Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An Airflow cluster must be created as a custom resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: airflow.stackable.tech/v1alpha1
kind: AirflowCluster
metadata:
  name: airflow
spec:
  version: 2.2.4-python3.9-stackable0.3.0
  statsdExporterVersion: v0.22.4
  executor: CeleryExecutor
  loadExamples: true
  exposeConfig: false
  credentialsSecret: simple-airflow-credentials
  webservers:
    roleGroups:
      default:
        replicas: 1
  workers:
    roleGroups:
      default:
        replicas: 2
  schedulers:
    roleGroups:
      default:
        replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that the version you need to specify is not only the version of Airflow which you want to roll out, but has to be amended with a Stackable version as shown.
This Stackable version is the version of the underlying container image which is used to execute the processes.
For a list of available versions please check our <a href="https://repo.stackable.tech/#browse/browse:docker:v2%2Fstackable%2Fairflow%2Ftags">image registry</a>.
It should generally be safe to simply use the latest image version that is available.</p>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>metadata.name</code> contains the name of the Airflow cluster</p>
</li>
<li>
<p>the label of the Docker image provided by Stackable must be set in <code>spec.version</code></p>
</li>
<li>
<p><code>spec.statsdExporterVersion</code> must contain the tag of a statsd-exporter Docker image in the Stackable repository.</p>
</li>
<li>
<p><code>spec.executor</code>: this setting determines how the cluster will run (for more information see <a href="https://airflow.apache.org/docs/apache-airflow/stable/executor/index.html#executor-types" class="bare">https://airflow.apache.org/docs/apache-airflow/stable/executor/index.html#executor-types</a>): the <code>CeleryExecutor</code>
is the recommended setting although <code>SequentialExecutor</code> (all jobs run in one process in series) and <code>LocalExecutor</code>
(whereby all jobs are run on one node, using whatever parallelism is possible) are also supported</p>
</li>
<li>
<p>importing the sample workflows is determined by <code>loadExamples</code></p>
</li>
<li>
<p><code>exposeConfig</code> allows the contents of the configuration file <code>airflow.cfg</code> to be exposed via the webserver UI. This is only for debugging purposes and should be set to <code>false</code> otherwise as it presents a security risk.</p>
</li>
<li>
<p>the previously created secret must be referenced in <code>credentialsSecret</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each cluster requires 3 components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>webservers</code>: this provides the main UI for user-interaction</p>
</li>
<li>
<p><code>workers</code>: the nodes over which the job workload will be distributed by the scheduler</p>
</li>
<li>
<p><code>schedulers</code>: responsible for triggering jobs and persisting their metadata to the backend database</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring"><a class="anchor" href="#_monitoring"></a>Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The managed Airflow instances are automatically configured to export Prometheus metrics. See
<a href="../../home/stable/operators/monitoring.html" class="xref page">Monitoring</a> for more details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_environment_overrides"><a class="anchor" href="#_configuration_environment_overrides"></a>Configuration &amp; Environment Overrides</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The cluster definition also supports overriding configuration properties and environment variables, either per role or per role group, where the more specific override (role group) has precedence over the less specific one (role).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Overriding certain properties which are set by operator (such as the HTTP port) can interfere with the operator and can lead to problems. Additionally for Airflow it is recommended
that each component has the same configuration: not all components use each setting, but some things - such as external end-points - need to be consistent for things to work as expected.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_configuration_properties"><a class="anchor" href="#_configuration_properties"></a>Configuration Properties</h3>
<div class="paragraph">
<p>Airflow exposes an environment variable for every configuration setting, a list of which can be found in the <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html">Configuration Reference</a>.</p>
</div>
<div class="paragraph">
<p>Although Kubernetes can override these settings in one of two ways (Configuration overrides, or Environment Variable overrides), the affect is the same
and currently only the latter is implemented. This is described in the following section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_environment_variables"><a class="anchor" href="#_environment_variables"></a>Environment Variables</h3>
<div class="paragraph">
<p>These can be set - or overwritten - at either the role level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  webservers:
    envOverrides:
      AIRFLOW__WEBSERVER__AUTO_REFRESH_INTERVAL: "8"
    roleGroups:
      default:
        replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or per role group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  webservers:
    roleGroups:
      default:
        envOverrides:
          AIRFLOW__WEBSERVER__AUTO_REFRESH_INTERVAL: "8"
        replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>In both examples above we are replacing the default value of the UI DAG refresh (3s) with 8s. Note that all override property values must be strings.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initializing_the_airflow_database"><a class="anchor" href="#_initializing_the_airflow_database"></a>Initializing the Airflow database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Airflow comes with a default embedded database (intended only for standalone mode): for cluster usage an external database is used such as PostgreSQL, described above. This database must be initialized with an airflow schema and the Admin user defined in the airflow credentials <code>Secret</code>. This is done the first time the cluster is created and can take a few moments.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_airflow"><a class="anchor" href="#_using_airflow"></a>Using Airflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the Airflow cluster is created and the database is initialized, Airflow can be opened in the
browser.</p>
</div>
<div class="paragraph">
<p>The Airflow port which defaults to <code>8080</code> can be forwarded to the local host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl port-forward airflow-webserver-default-0 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then it can be opened in the browser with <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code>.</p>
</div>
<div class="paragraph">
<p>Enter the admin credentials from the Kubernetes secret:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/airflow_login.png" alt="Login screen of Airflow">
</div>
</div>
<div class="paragraph">
<p>If the examples were loaded then some dashboards are already available:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/airflow_dags.png" alt="Airflow UI showing example DAGs">
</div>
</div>
<div class="paragraph">
<p>Click on an example DAG and then invoke the job: if the scheduler is correctly set up then the job
will run and the job tree will update automatically:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/airflow_running.png" alt="Airflow UI showing a running DAG">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring_2"><a class="anchor" href="#_monitoring_2"></a>Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The managed Airflow instances are automatically configured to export Prometheus metrics. See
<a href="../../home/stable/operators/monitoring.html" class="xref page">Monitoring</a> for more details</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mounting_dags"><a class="anchor" href="#_mounting_dags"></a>Mounting DAGs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>DAGs can be mounted by using a <code>ConfigMap</code> or a <code>PersistentVolumeClaim</code>. This is best illustrated with an example of each, shown in the next section.</p>
</div>
<div class="sect2">
<h3 id="_via_configmap"><a class="anchor" href="#_via_configmap"></a>via <code>ConfigMap</code></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-dag <i class="conum" data-value="1"></i><b>(1)</b>
data:
  test_airflow_dag.py: | <i class="conum" data-value="2"></i><b>(2)</b>
    from datetime import datetime, timedelta
    from airflow import DAG
    from airflow.operators.bash import BashOperator
    from airflow.operators.dummy import DummyOperator

    with DAG(
        dag_id='test_airflow_dag',
        schedule_interval='0 0 * * *',
        start_date=datetime(2021, 1, 1),
        catchup=False,
        dagrun_timeout=timedelta(minutes=60),
        tags=['example', 'example2'],
        params={"example_key": "example_value"},
    ) as dag:
        run_this_last = DummyOperator(
            task_id='run_this_last',
        )

        # [START howto_operator_bash]
        run_this = BashOperator(
            task_id='run_after_loop',
            bash_command='echo 1',
        )
        # [END howto_operator_bash]

        run_this &gt;&gt; run_this_last

        for i in range(3):
            task = BashOperator(
                task_id='runme_' + str(i),
                bash_command='echo "{{ task_instance_key_str }}" &amp;&amp; sleep 1',
            )
            task &gt;&gt; run_this

        # [START howto_operator_bash_template]
        also_run_this = BashOperator(
            task_id='also_run_this',
            bash_command='echo "run_id={{ run_id }} | dag_run={{ dag_run }}"',
        )
        # [END howto_operator_bash_template]
        also_run_this &gt;&gt; run_this_last

    # [START howto_operator_bash_skip]
    this_will_skip = BashOperator(
        task_id='this_will_skip',
        bash_command='echo "hello world"; exit 99;',
        dag=dag,
    )
    # [END howto_operator_bash_skip]
    this_will_skip &gt;&gt; run_this_last

    if __name__ == "__main__":
        dag.cli()</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>---
apiVersion: airflow.stackable.tech/v1alpha1
kind: AirflowCluster
metadata:
  name: airflow
spec:
  version: 2.2.5-python39-stackable0.3.0
  statsdExporterVersion: v0.22.4
  executor: CeleryExecutor
  loadExamples: false
  exposeConfig: false
  credentialsSecret: simple-airflow-credentials
  volumes:
    - name: cm-dag <i class="conum" data-value="3"></i><b>(3)</b>
      configMap:
        name: cm-dag <i class="conum" data-value="4"></i><b>(4)</b>
  volumeMounts:
    - name: cm-dag <i class="conum" data-value="5"></i><b>(5)</b>
      mountPath: /dags/test_airflow_dag.py <i class="conum" data-value="6"></i><b>(6)</b>
      subPath: test_airflow_dag.py <i class="conum" data-value="7"></i><b>(7)</b>
  webservers:
    roleGroups:
      default:
        envOverrides:
          AIRFLOW__CORE__DAGS_FOLDER: "/dags" <i class="conum" data-value="8"></i><b>(8)</b>
        replicas: 1
  workers:
    roleGroups:
      default:
        envOverrides:
          AIRFLOW__CORE__DAGS_FOLDER: "/dags" <i class="conum" data-value="8"></i><b>(8)</b>
        replicas: 2
  schedulers:
    roleGroups:
      default:
        envOverrides:
          AIRFLOW__CORE__DAGS_FOLDER: "/dags" <i class="conum" data-value="8"></i><b>(8)</b>
        replicas: 1</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of the configuration map</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the DAG (this is a renamed copy of the <code>example_bash_operator.py</code> from the Airflow examples)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The volume backed by the configuration map</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The name of the configuration map referenced by the Airflow cluster</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The name of the mounted volume</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The path of the mounted resource. Note that should map to a single DAG.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The resource has to be defined using <code>subPath</code>: this is to prevent the versioning of configuration map elements which may cause a conflict with how Airflow propagates DAGs between its components.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>If the mount path described above is anything other than the standard location (the default is <code>$AIRFLOW_HOME/dags</code>), then the location should be defined using the relevant environment variable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The advantage of this approach is that a DAG can be provided "in-line", as it were. This becomes cumbersome when multiple DAGs are to be made available in this way, as each one has to be mapped individually. For multiple DAGs it is probably easier to expose them all via a mounted volume, which is shown below.</p>
</div>
</div>
<div class="sect2">
<h3 id="_via_persistentvolumeclaim"><a class="anchor" href="#_via_persistentvolumeclaim"></a>via <code>PersistentVolumeclaim</code></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-airflow <i class="conum" data-value="1"></i><b>(1)</b>
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: batch/v1
kind: Job <i class="conum" data-value="2"></i><b>(2)</b>
metadata:
  name: airflow-dags
spec:
  template:
    spec:
      restartPolicy: Never
      volumes:
        - name: external-dags <i class="conum" data-value="3"></i><b>(3)</b>
          persistentVolumeClaim:
            claimName: pvc-airflow <i class="conum" data-value="4"></i><b>(4)</b>
      initContainers:
        - name: dest-dir
          image: docker.stackable.tech/stackable/tools:0.2.0-stackable0
          env:
            - name: DEST_DIR
              value: "/stackable/externals"
          command:
            [
              "bash",
              "-x",
              "-c",
              "mkdir -p $DEST_DIR &amp;&amp; chown stackable:stackable ${DEST_DIR} &amp;&amp; chmod -R a=,u=rwX,g=rwX ${DEST_DIR}",
            ]
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: external-dags <i class="conum" data-value="5"></i><b>(5)</b>
              mountPath: /stackable/externals <i class="conum" data-value="6"></i><b>(6)</b>
      containers:
        - name: airflow-dags
          image: docker.stackable.tech/stackable/tools:0.2.0-stackable0
          env:
            - name: DEST_DIR
              value: "/stackable/externals"
          command: <i class="conum" data-value="7"></i><b>(7)</b>
            [
              "bash",
              "-x",
              "-c",
              "curl -L  https://raw.githubusercontent.com/apache/airflow/2.2.5/airflow/example_dags/example_bash_operator.py \
              -o ${DEST_DIR}/example_bash_operator.py &amp;&amp; \
              curl -L  https://raw.githubusercontent.com/apache/airflow/2.2.5/airflow/example_dags/example_complex.py \
              -o ${DEST_DIR}/example_complex.py &amp;&amp; \
              curl -L  https://raw.githubusercontent.com/apache/airflow/2.2.5/airflow/example_dags/example_branch_datetime_operator.py \
              -o ${DEST_DIR}/example_branch_datetime_operator.py",
            ]
          volumeMounts:
            - name: external-dags <i class="conum" data-value="5"></i><b>(5)</b>
              mountPath: /stackable/externals <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: airflow.stackable.tech/v1alpha1
kind: AirflowCluster
metadata:
  name: airflow
spec:
  version: 2.2.4-python39-stackable0.3.0
  statsdExporterVersion: v0.22.4
  executor: CeleryExecutor
  loadExamples: false
  exposeConfig: false
  credentialsSecret: simple-airflow-credentials
  volumes:
    - name: external-dags <i class="conum" data-value="8"></i><b>(8)</b>
      persistentVolumeClaim:
        claimName: pvc-airflow <i class="conum" data-value="9"></i><b>(9)</b>
  volumeMounts:
    - name: external-dags <i class="conum" data-value="10"></i><b>(10)</b>
      mountPath: /stackable/external-dags <i class="conum" data-value="11"></i><b>(11)</b>
  webservers:
    roleGroups:
      default:
        envOverrides:
          AIRFLOW__CORE__DAGS_FOLDER: "/stackable/external-dags" <i class="conum" data-value="12"></i><b>(12)</b>
        replicas: 1
  workers:
    roleGroups:
      default:
        envOverrides:
          AIRFLOW__CORE__DAGS_FOLDER: "/stackable/external-dags" <i class="conum" data-value="12"></i><b>(12)</b>
        replicas: 2
  schedulers:
    roleGroups:
      default:
        envOverrides:
          AIRFLOW__CORE__DAGS_FOLDER: "/stackable/external-dags" <i class="conum" data-value="12"></i><b>(12)</b>
        replicas: 1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of the <code>PersistentVolumeClaim</code> that references the PV</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Job used to populate the <code>PersistentVolumeClaim</code> with DAG files</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The volume name that will be mounted as a target for the DAG files</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Defines the <code>Volume</code> backed by the PVC, local to the Custom Resource</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>VolumeMount</code> used by the Custom Resource</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The path for the <code>VolumeMount</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The command used to access/download the DAG files to a specified location</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The <code>Volume</code> used by this Custom Resource</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The <code>PersistentVolumeClaim</code> that backs this <code>Volume</code></td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The <code>VolumeMount</code> referencing the <code>Volume</code> in the previous step</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The path where this <code>Volume</code> is located for each role (webserver, worker, scheduler)</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>If the mount path described above is anything other than the standard location (the default is <code>$AIRFLOW_HOME/dags</code>), then the location should be defined using the relevant environment variable.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
    </div>
</div>
<footer class="footer">
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
