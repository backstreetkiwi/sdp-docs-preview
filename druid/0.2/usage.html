<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Usage :: Stackable Documentation</title>
    <link rel="canonical" href="https://docs.stackable.tech/druid/stable/usage.html">
    <meta name="generator" content="Antora 3.1.0">
    <link rel="stylesheet" href="../../_/css/site.css">
    <script>var uiRootPath = '../../_'</script>
    <link rel="icon" href="../../_/img/favicon.png" type="image/png">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://stackable.tech"><img src="../../_/img/stackable-logo.png"></a>
      <a class="navbar-item documentation-link" href="https://docs.stackable.tech">Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search...">
        </div>
      </div>
      <button class="navbar-burger" data-target="navbar-sub">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <a href="https://www.stackable.tech/contact/" class="button pull-right">Contact Us</a>
    </div>
      <div id="topbar-nav" class="navbar-menu">
      </div>
      </div>
    </nav>
    <nav id="navbar-sub" class="navbar-sub">
      <div class="container">
        <a class="navbar-sub-item" href="../../home/stable/index.html">Home</a>
<a class="navbar-sub-item" href="../../home/stable/getting_started.html">Getting Started</a>
<a class="navbar-sub-item" href="../../home/stable/concepts/index.html">Concepts</a>
<a class="navbar-sub-item" href="../../home/stable/tutorials/end-to-end_data_pipeline_example.html">Tutorials</a>
<a class="navbar-sub-item" href="../../stackablectl/stable/index.html">stackablectl</a>
<div class="navbar-sub-item drop-down">
    Operators
    <div class="drop-down-content">
        <a class="drop-down-item" href="../../home/stable/operators/index.html">Overview</a>
        <a class="drop-down-item" href="../../airflow/stable/index.html">Apache Airflow</a>
        <a class="drop-down-item" href="../stable/index.html">Apache Druid</a>
        <a class="drop-down-item" href="../../hbase/stable/index.html">Apache HBase</a>
        <a class="drop-down-item" href="../../hdfs/stable/index.html">Apache Hadoop HDFS</a>
        <a class="drop-down-item" href="../../hive/stable/index.html">Apache Hive</a>
        <a class="drop-down-item" href="../../kafka/stable/index.html">Apache Kafka</a>
        <a class="drop-down-item" href="../../nifi/stable/index.html">Apache NiFi</a>
        <a class="drop-down-item" href="../../spark-k8s/stable/index.html">Apache Spark on K8S</a>
        <a class="drop-down-item" href="../../superset/stable/index.html">Apache Superset</a>
        <a class="drop-down-item" href="../../trino/stable/index.html">Trino</a>
        <a class="drop-down-item" href="../../zookeeper/stable/index.html">Apache ZooKeeper</a>
        <a class="drop-down-item" href="../../opa/stable/index.html">OpenPolicyAgent</a>
        <a class="drop-down-item" href="../../commons-operator/stable/index.html">Commons</a>
        <a class="drop-down-item" href="../../secret-operator/stable/index.html">Secret</a>
        <a class="drop-down-item" href="../../listener-operator/stable/index.html">Listener</a>
    </div>
</div>
<a class="navbar-sub-item" href="../../home/stable/contributor/index.html">Contribute</a>

        <a class="arrow" href="javascript:document.querySelector('.navbar-sub').classList.toggle('open')">
          <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"></path></svg>
        </a>
      </div>
    </nav>
  </header>
<div class="body">
    <div class="container">
<div class="nav-container" data-component="druid" data-version="0.2">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <div class="title-wrapper">
      <h3 class="title"><a href="index.html">Stackable Operator for Apache Druid</a></h3>
      <div class="page-versions">
        <button class="version-menu-toggle" title="Show other versions of page">0.2</button>
        <div class="version-menu">
          <a class="version" href="../nightly/usage.html">nightly</a>
          <a class="version" href="../stable/usage.html">0.8</a>
          <a class="version" href="../0.7/usage.html">0.7</a>
          <a class="version" href="../0.6/usage.html">0.6</a>
          <a class="version is-current" href="usage.html">0.2</a>
          <a class="version" href="../0.1/usage.html">0.1</a>
        </div>
      </div>
    </div>
    <ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="installation.html">Installation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="configuration.html">Configuration</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="usage.html">Usage</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Concepts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="discovery.html">Discovery</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Stackable Operator for Apache Druid</span>
    <span class="version">0.2</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../commons-operator/stable/index.html">Stackable Commons Operator</a>
      <ul class="versions">
        <li class="version">
          <a href="../../commons-operator/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../commons-operator/stable/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../commons-operator/0.3/index.html">0.3</a>
        </li>
        <li class="version">
          <a href="../../commons-operator/0.2/index.html">0.2</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../home/stable/index.html">Stackable Documentation</a>
      <ul class="versions">
        <li class="version">
          <a href="../../home/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../home/stable/index.html">22.11</a>
        </li>
        <li class="version">
          <a href="../../home/22.09/index.html">22.09</a>
        </li>
        <li class="version">
          <a href="../../home/22.06/index.html">22.06</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../listener-operator/stable/index.html">Stackable Listener Operator</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../listener-operator/stable/index.html">nightly</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../airflow/stable/index.html">Stackable Operator for Apache Airflow</a>
      <ul class="versions">
        <li class="version">
          <a href="../../airflow/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../airflow/stable/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../airflow/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../airflow/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../airflow/0.3/index.html">0.3</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../stable/index.html">Stackable Operator for Apache Druid</a>
      <ul class="versions">
        <li class="version">
          <a href="../nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../0.6/index.html">0.6</a>
        </li>
        <li class="version is-current">
          <a href="index.html">0.2</a>
        </li>
        <li class="version">
          <a href="../0.1/index.html">0.1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../hbase/stable/index.html">Stackable Operator for Apache HBase</a>
      <ul class="versions">
        <li class="version">
          <a href="../../hbase/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../hbase/stable/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../hbase/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../hbase/0.3/index.html">0.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../hdfs/stable/index.html">Stackable Operator for Apache HDFS</a>
      <ul class="versions">
        <li class="version">
          <a href="../../hdfs/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../hdfs/stable/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../hdfs/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../hdfs/0.4/index.html">0.4</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../hive/stable/index.html">Stackable Operator for Apache Hive</a>
      <ul class="versions">
        <li class="version">
          <a href="../../hive/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../hive/stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../hive/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../hive/0.6/index.html">0.6</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../kafka/stable/index.html">Stackable Operator for Apache Kafka</a>
      <ul class="versions">
        <li class="version">
          <a href="../../kafka/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../kafka/stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../kafka/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../kafka/0.6/index.html">0.6</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../nifi/stable/index.html">Stackable Operator for Apache NiFi</a>
      <ul class="versions">
        <li class="version">
          <a href="../../nifi/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../nifi/stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../nifi/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../nifi/0.6/index.html">0.6</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../spark-k8s/stable/index.html">Stackable Operator for Apache Spark on Kubernetes</a>
      <ul class="versions">
        <li class="version">
          <a href="../../spark-k8s/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../spark-k8s/stable/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../spark-k8s/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../spark-k8s/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../spark-k8s/0.3/index.html">0.3</a>
        </li>
        <li class="version">
          <a href="../../spark-k8s/0.2/index.html">0.2</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../superset/stable/index.html">Stackable Operator for Apache Superset</a>
      <ul class="versions">
        <li class="version">
          <a href="../../superset/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../superset/stable/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../superset/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../superset/0.5/index.html">0.5</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../zookeeper/stable/index.html">Stackable Operator for Apache ZooKeeper</a>
      <ul class="versions">
        <li class="version">
          <a href="../../zookeeper/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../zookeeper/stable/index.html">0.12</a>
        </li>
        <li class="version">
          <a href="../../zookeeper/0.11/index.html">0.11</a>
        </li>
        <li class="version">
          <a href="../../zookeeper/0.10/index.html">0.10</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../opa/stable/index.html">Stackable Operator for OPA</a>
      <ul class="versions">
        <li class="version">
          <a href="../../opa/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../opa/stable/index.html">0.11</a>
        </li>
        <li class="version">
          <a href="../../opa/0.10/index.html">0.10</a>
        </li>
        <li class="version">
          <a href="../../opa/0.9/index.html">0.9</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../trino/stable/index.html">Stackable Operator for Trino</a>
      <ul class="versions">
        <li class="version">
          <a href="../../trino/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../trino/stable/index.html">0.8</a>
        </li>
        <li class="version">
          <a href="../../trino/0.7/index.html">0.7</a>
        </li>
        <li class="version">
          <a href="../../trino/0.6/index.html">0.6</a>
        </li>
        <li class="version">
          <a href="../../trino/0.5/index.html">0.5</a>
        </li>
        <li class="version">
          <a href="../../trino/0.4/index.html">0.4</a>
        </li>
        <li class="version">
          <a href="../../trino/0.3/index.html">0.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../secret-operator/stable/index.html">Stackable Secret Operator</a>
      <ul class="versions">
        <li class="version">
          <a href="../../secret-operator/nightly/index.html">nightly</a>
        </li>
        <li class="version is-latest">
          <a href="../../secret-operator/stable/index.html">0.5</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../stackablectl/stable/index.html">stackablectl</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../stackablectl/stable/index.html">nightly</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../home/stable/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Stackable Operator for Apache Druid</a></li>
    <li><a href="usage.html">Usage</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/stackabletech/druid-operator/blob/docs/0.2/docs/modules/ROOT/pages/usage.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Usage</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Druid requires a Zookeeper to run, as well as a database. If HDFS is used as the backend-storage (so called "deep storage") then the HDFS operator is required as well.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_prerequisites"><a class="anchor" href="#_setup_prerequisites"></a>Setup Prerequisites</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_zookeeper_operator"><a class="anchor" href="#_zookeeper_operator"></a>Zookeeper operator</h3>
<div class="paragraph">
<p>Please refer to the <a href="https://github.com/stackabletech/zookeeper-operator">Zookeeper</a> operator and <a href="https://docs.stackable.tech/zookeeper/index.html">docs</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hdfs_operator_optional"><a class="anchor" href="#_hdfs_operator_optional"></a>HDFS operator (optional)</h3>
<div class="paragraph">
<p>Please refer to the <a href="https://github.com/stackabletech/hdfs-operator">HDFS</a> operator and <a href="https://docs.stackable.tech/hdfs/index.html">docs</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sql_database"><a class="anchor" href="#_sql_database"></a>SQL Database</h3>
<div class="paragraph">
<p>Druid requires a MySQL or Postgres database.</p>
</div>
<div class="paragraph">
<p>For testing purposes, you can spin up a PostgreSQL database with the bitnami PostgreSQL helm chart.  Add the bitnami repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm repo add bitnami https://charts.bitnami.com/bitnami</code></pre>
</div>
</div>
<div class="paragraph">
<p>And set up the Postgres database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install druid bitnami/postgresql \
--version=11 \
--set auth.username=druid \
--set auth.password=druid \
--set auth.database=druid</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_druid_cluster"><a class="anchor" href="#_creating_a_druid_cluster"></a>Creating a Druid Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the prerequisites fulfilled, the CRD for this operator must be created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f /etc/stackable/druid-operator/crd</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then a cluster can be deployed using the example below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: druid.stackable.tech/v1alpha1
kind: DruidCluster
metadata:
  name: simple-druid
spec:
  version: 0.22.1
  zookeeperConfigMapName: simple-zk
  metadataStorageDatabase:
    dbType: postgresql
    connString: jdbc:postgresql://druid-postgresql/druid
    host: druid-postgresql    # this is the name of the Postgres service
    port: 5432
    user: druid
    password: druid
  deepStorage:
    storageType: hdfs
    storageDirectory: hdfs://path/to/druidDeepStorage
  brokers:
    roleGroups:
      default:
        config: {}
        replicas: 1
  coordinators:
    roleGroups:
      default:
        config: {}
        replicas: 1
  historicals:
    roleGroups:
      default:
        config: {}
        replicas: 1
  middleManagers:
    roleGroups:
      default:
        config: {}
        replicas: 1
  routers:
    roleGroups:
      default:
        config: {}
        replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Router is hosting the web UI, a <code>NodePort</code> service is created by the operator to access the web UI. Connect to the <code>simple-druid-router</code> <code>NodePort</code> service and follow the <a href="https://druid.apache.org/docs/latest/tutorials/index.html#step-4-load-data">druid documentation</a> on how to load and query sample data.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_s3"><a class="anchor" href="#_using_s3"></a>Using S3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Stackable Platform uses a common set of resource definitions for s3 across all operators, explained in detail on the <a href="TODO">S3 resources</a> page. In general, you can configure an S3 connection or bucket inline, or as a reference to a dedicated object.</p>
</div>
<div class="paragraph">
<p>In Druid, S3 can be used for two things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ingesting data from a bucket</p>
</li>
<li>
<p>Using it as a backend for deep storage</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can specify just a connection/bucket or just one of these or for both, but Druid only supports a single S3 endpoint under the hood, so if two connections are specified, they must be the same. This is easiest if a dedicated <a href="to_s3_docs">S3 Connection Resource</a> is used.</p>
</div>
<div class="paragraph">
<p>TLS for S3 is not yet supported.</p>
</div>
<div class="sect2">
<h3 id="_s3_for_ingestion"><a class="anchor" href="#_s3_for_ingestion"></a>S3 for ingestion</h3>
<div class="paragraph">
<p>To ingest data from s3, you need to specify at least an endpoint to use, but there are more settings that can be set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  ingestion:
    s3connection:
      host: yourhost.com  <i class="conum" data-value="1"></i><b>(1)</b>
      port: 80 # optional <i class="conum" data-value="2"></i><b>(2)</b>
      secretClass: my-s3-credentials  # optional <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The S3 host, not optional</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Port, optional, defaults to 80</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Credentials to use. Since these might be bucket-dependent, they can instead be given in the ingestion job</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_s3_deep_storage"><a class="anchor" href="#_s3_deep_storage"></a>S3 deep storage</h3>
<div class="paragraph">
<p>Druid can use S3 as a backend for deep storage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  deepStorage:
    s3:
      inline:
        bucketName: my-bucket  <i class="conum" data-value="1"></i><b>(1)</b>
        connection:
          inline:
            host: test-minio  <i class="conum" data-value="2"></i><b>(2)</b>
            port: 9000  <i class="conum" data-value="3"></i><b>(3)</b>
            secretClass: minio-credentials  <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Bucket name.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bucket host.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Optional bucket port.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of the <code>Secret</code> object expected to contain the following keys: <code>ACCESS_KEY_ID</code> and <code>SECRET_ACCESS_KEY</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is also possible to configure the bucket connection details as a separate Kubernetes resource and only refer to that object from the <code>DruidCluster</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spec:
  deepStorage:
    s3:
      reference: my-bucket-resource <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Name of the bucket resource with connection details.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The resource named <code>my-bucket-resource</code> is then defined as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">---
apiVersion: s3.stackable.tech/v1alpha1
kind: S3Bucket
metadata:
  name: my-bucket-resource
spec:
  bucketName: my-bucket-name
  connection:
    inline:
      host: test-minio
      port: 9000
      secretClass: minio-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>This has the advantage that bucket configuration can be shared across `DruidClusters`s (and other stackable CRDs) and reduces the cost of updating these details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_open_policy_agent_opa_for_authorization"><a class="anchor" href="#_using_open_policy_agent_opa_for_authorization"></a>Using Open Policy Agent (OPA) for Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Druid can connect to an Open Policy Agent (OPA) instance for authorization policy decisions. You need to run an OPA instance to connect to, for which we refer to the <a href="https://docs.stackable.tech/opa/index.html">OPA Operator docs</a>. How you can write RegoRules for Druid is explained <a href="#_defining_regorules">below</a>.</p>
</div>
<div class="paragraph">
<p>Once you have defined your rules, you need to configure the OPA cluster name and endpoint to use for Druid authorization requests. Add a section to the <code>spec</code> for OPA:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">opa:
  configMapName: simple-opa <i class="conum" data-value="1"></i><b>(1)</b>
  package: my-druid-rules <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The name of your OPA cluster (<code>simple-opa</code> in this case)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The RegoRule package to use for policy decisions. The package should contain an <code>allow</code> rule. This is optional and will default to the name of the Druid cluster.</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_defining_regorules"><a class="anchor" href="#_defining_regorules"></a>Defining RegoRules</h3>
<div class="paragraph">
<p>For a general explanation of how rules are written, we refer to the <a href="https://www.openpolicyagent.org/docs/latest/#rego">OPA documentation</a>. Inside your rule you will have access to input from Druid. Druid provides this data to you to base your policy decisions on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "user": "someUsername", <i class="conum" data-value="1"></i><b>(1)</b>
  "action": "READ", <i class="conum" data-value="2"></i><b>(2)</b>
  "resource": {
    "type": "DATASOURCE", <i class="conum" data-value="3"></i><b>(3)</b>
    "name": "myTable" <i class="conum" data-value="4"></i><b>(4)</b>
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The authenticated identity of the user that wants to perform the action</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The action type, can be either <code>READ</code> or <code>WRITE</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The resource type, one of <code>STATE</code>, <code>CONFIG</code> and <code>DATASOURCE</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>In case of a datasource this is the table name, for <code>STATE</code> this will simply be <code>STATE</code>, the same for <code>CONFIG</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more details consult the <a href="https://druid.apache.org/docs/latest/operations/security-user-auth.html#authentication-and-authorization-model">Druid Authentication and Authorization Model</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connecting_to_druid_from_other_services"><a class="anchor" href="#_connecting_to_druid_from_other_services"></a>Connecting to Druid from other Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The operator creates a <code>ConfigMap</code> with the name of the cluster which contains connection information. Following our example above (the name of the cluster is <code>simple-druid</code>) a <code>ConfigMap</code> with the name <code>simple-druid</code> will be created containing 3 keys:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DRUID_ROUTER</code> with the format <code>&lt;host&gt;:&lt;port&gt;</code>, which points to the router processes HTTP endpoint. Here you can connect to the web UI, or use REST endpoints such as <code>/druid/v2/sql/</code> to query data. <a href="https://druid.apache.org/docs/latest/querying/sql.html#http-post">More information in the Druid Docs</a>.</p>
</li>
<li>
<p><code>DRUID_AVATICA_JDBC</code> contains a JDBC connect string which can be used together with the <a href="https://calcite.apache.org/avatica/downloads/">Avatica JDBC Driver</a> to connect to Druid and query data. <a href="https://druid.apache.org/docs/latest/querying/sql.html#jdbc">More information in the Druid Docs</a>.</p>
</li>
<li>
<p><code>DRUID_SQALCHEMY</code> contains a connection string used to connect to Druid with SQAlchemy, in - for example - Apache Superset.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring"><a class="anchor" href="#_monitoring"></a>Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The managed Druid instances are automatically configured to export Prometheus metrics. See
<a href="../../home/stable/operators/monitoring.html" class="xref page">Monitoring</a> for more details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_environment_overrides"><a class="anchor" href="#_configuration_environment_overrides"></a>Configuration &amp; Environment Overrides</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The cluster definition also supports overriding configuration properties and environment variables, either per role or per role group, where the more specific override (role group) has precedence over the less specific one (role).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Overriding certain properties which are set by operator (such as the HTTP port) can interfere with the operator and can lead to problems.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_configuration_properties"><a class="anchor" href="#_configuration_properties"></a>Configuration Properties</h3>
<div class="paragraph">
<p>For a role or role group, at the same level of <code>config</code>, you can specify: <code>configOverrides</code> for the <code>runtime.properties</code>. For example, if you want to set the <code>druid.server.http.numThreads</code> for the router to 100 adapt the <code>routers</code> section of the cluster resource like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">routers:
  roleGroups:
    default:
      config: {}
      configOverrides:
        runtime.properties:
          druid.server.http.numThreads: "100"
      replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just as for the <code>config</code>, it is possible to specify this at role level as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">routers:
  configOverrides:
    runtime.properties:
      druid.server.http.numThreads: "100"
  roleGroups:
    default:
      config: {}
      replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>All override property values must be strings.</p>
</div>
<div class="paragraph">
<p>For a full list of configuration options we refer to the Druid <a href="https://druid.apache.org/docs/latest/configuration/index.html">Configuration Reference</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_environment_variables"><a class="anchor" href="#_environment_variables"></a>Environment Variables</h3>
<div class="paragraph">
<p>In a similar fashion, environment variables can be (over)written. For example per role group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">routers:
  roleGroups:
    default:
      config: {}
      envOverrides:
        MY_ENV_VAR: "MY_VALUE"
      replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>or per role:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">routers:
  envOverrides:
    MY_ENV_VAR: "MY_VALUE"
  roleGroups:
    default:
      config: {}
      replicas: 1</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
    </div>
</div>
<footer class="footer">
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
